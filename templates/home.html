<html>
  <head>
    <title>Book Logger</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static',filename='styles/home.css') }}"
    />
  </head>
  <body>
    <h1 class="header header-add">Log a Book</h1>
    <form class="form-add-book" method="POST" action="/">
      <input type="text" name="title" placeholder="Title" />
      <input type="text" name="author" placeholder="Author" />
      <input type="text" name="published" placeholder="Year" />
      <input type="text" name="pages" placeholder="Page Count" />
      <button type="submit">Add Book</button>
    </form>

    <div class="search">
      <h1>Book Search</h1>
      <form method="POST" action="/search">
        <input
          type="text"
          name="search"
          placeholder="Enter book title or author"
        />
        <button type="submit">Search</button>
      </form>

      {% if results %}
      <h2>Search Results for "{{ search_term }}":</h2>
      <ul>
        {% for book in results %}
        <div class="book-result">
          <h3>{{ book['volumeInfo'].get('title', 'Title Unavailable') }}</h3>
          <p>by {{ book['volumeInfo'].get('authors', ['Unknown'])[0] }}</p>
          <button
            class="save-book"
            data-title="{{ book['volumeInfo']['title'] }}"
            data-author="{{ book['volumeInfo'].get('authors', ['Unknown'])[0] }}"
            data-published="{{ book['volumeInfo'].get('publishedDate', 'Unknown') }}"
            data-pages="{{ book['volumeInfo'].get('pageCount', 'Unknown') }}"
          >
            Save Book
          </button>
        </div>
        {% endfor %}
      </ul>
      {% endif %}
      <!-- AJAX to save result to collection -->
      <script>
        const saveButtons = document.querySelectorAll(".save-book");
        saveButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const title = this.dataset.title;
            const author = this.dataset.author;
            const published = this.dataset.published;
            const pages = this.dataset.pages;

            // Send AJAX request to Flask
            fetch("/add_book", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                title: title,
                author: author,
                published: published,
                pages: pages,
              }),
            }).then((response) => {
              if (response.ok) {
                alert("Book added successfully!");
                window.location.href = "/"; // Redirect to the home route
              } else {
                alert("Error adding book.");
              }
            });
          });
        });
      </script>
    </div>

    <h1 class="header header-books">Books</h1>
    <table class="table-books">
      <tr class="books-column">
        <td class="books-column books-column-left">Title</td>
        <td class="books-column books-column-mid">Author</td>
        <td class="books-column books-column-mid">Published</td>
        <td class="books-column books-column-mid">Pages</td>
        <td class="books-column books-column-right">Update Title</td>
      </tr>
      {% for book in books %}
      <tr>
        <td>{{book.title}}</td>
        <td>{{book.author}}</td>
        <td>{{book.published}}</td>
        <td>{{book.pages}}</td>
        <td>
          <form method="POST" action="./update" style="display: inline">
            <input type="hidden" value="{{book.title}}" name="oldtitle" />
            <input type="text" value="{{book.title}}" name="newtitle" />
            <button type="submit">Update</button>
          </form>
        </td>
        <td class="cell-delete">
          <form method="POST" action="./delete" style="display: inline">
            <input type="hidden" value="{{book.title}}" name="title" />
            <button class="button-delete" type="submit">Delete Book</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
  </body>
</html>
